<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Администрирование собеседования</title>
    <link rel="stylesheet" href="/admin.css" />
    <!-- Ссылка на внешний CSS файл -->
    <script src="/socket.io/socket.io.js"></script>
    <!-- Ссылка на библиотеку Socket.io -->
  </head>
  <body>
    <!-- Модальное окно для переименования комнаты -->
    <div id="renameModal" class="modal">
      <div class="modal-content">
        <input type="text" id="newRoomName" placeholder="Новое имя комнаты" />
        <!-- Поле ввода для нового имени комнаты -->
        <button id="modalRenameButton">Переименовать</button>
        <!-- Кнопка для отправки нового имени комнаты -->

        <span class="close">&times;</span>
        <!-- Кнопка закрытия модального окна -->
      </div>
    </div>

    <div id="adminOptions">
      <!-- Секция административных опций -->
      <div class="adminHeader">
        <h2>Административные опции</h2>
        <div class="button-group">
          <button id="videoPageButton">Открыть пустое окно для видео</button>
          <button id="videoExitButton">Выйти из всех комнат</button>
        </div>
      </div>
      <div id="rooms"></div>
      <!-- Контейнер для списка комнат -->
    </div>
    <div id="chatContainer">
      <div id="chatBottom">
        <h2>Чат</h2>
        <div id="chatBox">
          <div id="chatBoxInner"></div>
        </div>
        <!-- Контейнер для сообщений чата -->
        <div id="messageInputContainer">
          <select id="userDropdown">
            <!-- Выпадающий список для выбора пользователя -->
          </select>
          <input
            type="text"
            id="messageInput"
            placeholder="Введите сообщение"
          />
          <!-- Поле ввода для сообщения -->
        </div>
        <button id="sendMessage">Отправить</button>
        <!-- Кнопка отправки сообщения -->
      </div>
    </div>
  </body>

  <script>
    const socket = io(); // Инициализация соединения с сервером через Socket.io

    // Элементы DOM для работы с модальным окном
    const renameModal = document.getElementById("renameModal");
    const closeSpan = document.getElementsByClassName("close")[0];
    const modalRenameButton = document.getElementById("modalRenameButton");
    const newRoomName = document.getElementById("newRoomName");
    const videoExitButton = document.getElementById("videoExitButton");
    const messageInput = document.getElementById("messageInput");
    const sendMessage = document.getElementById("sendMessage");
    const userDropdown = document.getElementById("userDropdown"); // Получаем элемент выпадающего списка
    const chatBox = document.getElementById("chatBoxInner");
    let roomsLet = "";

    // Добавляем обработчик событий нажатия кнопок для newRoomName
    newRoomName.addEventListener("keyup", function (event) {
      //Проверяем нажатие Enter
      if (event.key === "Enter") {
        // Если клавиша Enter была нажата, нажимаем кнопку "Переименовать"

        modalRenameButton.click();
      }
    });

    sendMessage.addEventListener("click", () => {
      socket.emit("chatSendMessage", userDropdown.value, messageInput.value);
      messageInput.value = "";
    });

    socket.on("chatInputMessage", (msg_from, msg_to, msg_text) => {
      const addChatItem = document.createElement("div");
      let to_text = "Всем";
      let from_text = "Админ";
      if (msg_to == "Admin") {
        to_text = "Админ";
      } else if (msg_to != "all") {
        to_text = roomsLet[msg_to].listenerFullName;
      }
      if (msg_from != "Admin") {
        from_text = roomsLet[msg_from].listenerFullName;
      }
      addChatItem.textContent = from_text + " > " + to_text + ": " + msg_text;
      chatBox.appendChild(addChatItem);
    });

    messageInput.addEventListener("keyup", function (event) {
      //Проверяем нажатие Enter
      if (event.key === "Enter") {
        // Если клавиша Enter была нажата, нажимаем кнопку "Отправить"
        sendMessage.click();
      }
    });

    socket.emit("GetRooms"); // Запрос списка комнат с сервера
    socket.emit("isAdmin");

    // Функция для создания кнопки "Переименовать"
    function createRenameButton(roomId, roomNme) {
      const renameButton = document.createElement("button");
      renameButton.textContent = "Переименовать";
      renameButton.addEventListener("click", () => {
        // Логика переименования комнаты
        modalRenameButton.dataset.roomId = roomId;

        newRoomName.value = roomNme;
        renameModal.style.display = "block";
      });
      return renameButton;
    }

    // Функция для создания кнопки "Перезагрузить"
    function createReloadButton(roomId) {
      const reloadButton = document.createElement("button");
      reloadButton.textContent = "Перезагрузить";
      reloadButton.addEventListener("click", () => {
        socket.emit("sendRoomReload", roomId);
      });
      return reloadButton;
    }

    socket.on("disconnect", () => {
      console.warn("Соединение с сервером потеряно. Страница будет обновлена.");

      setTimeout(() => {
        location.reload();
      }, 1000); // задержка в 1 секунду перед обновлением страницы
    });

    // Функция для создания кнопки "Удалить"
    function createDeleteButton(roomId) {
      const deleteButton = document.createElement("button");
      deleteButton.textContent = "Удалить";
      deleteButton.addEventListener("click", () => {
        socket.emit("sendRoomDelete", roomId);
      });
      return deleteButton;
    }

    // Функция для создания кнопки "Подключиться"
    function createGoToButton(roomId) {
      const GoToButton = document.createElement("button");
      GoToButton.textContent = "Подключиться к комнате";
      GoToButton.addEventListener("click", () => {
        // Логика удаления комнаты
        socket.emit("adminGotoRoom", roomId);
      });
      return GoToButton;
    }

    // Функция для создания элемента комнаты
    function createRoomItem(roomId, room) {
      // Создание контейнера для комнаты
      const roomItem = document.createElement("div");
      roomItem.className = "room-item"; // Добавляем класс для стилизации

      // Создание ссылки на комнату
      const roomName = document.createElement("div");
      roomName.className = "room-name";
      roomName.textContent = room.listenerFullName;
      roomItem.appendChild(roomName);

      // Проверяем значение room.isConnected и меняем цвет фона
      if (room.isConnected) {
        roomItem.style.backgroundColor = "#00FF000F";
      } else {
        roomItem.style.backgroundColor = "#FF00000F";
      }

      // Создание контейнера для кнопок
      const buttonGroup = document.createElement("div");
      buttonGroup.className = "button-group";

      // Добавление кнопок в контейнер кнопок
      buttonGroup.appendChild(createGoToButton(roomId));
      buttonGroup.appendChild(
        createRenameButton(roomId, room.listenerFullName)
      );
      buttonGroup.appendChild(createReloadButton(roomId));
      buttonGroup.appendChild(createDeleteButton(roomId));

      // Добавление контейнера кнопок в контейнер комнаты
      roomItem.appendChild(buttonGroup);

      return roomItem;
    }

    // Функция для создания элемента опции
    function createUserOption(roomId, room, chckUserDrop) {
      const userOption = document.createElement("option");
      userOption.value = roomId; // Используем roomId как значение опции
      if (roomId == "all") {
        roomNme = "Всем";
      } else {
        roomNme = room.listenerFullName;
      }
      userOption.textContent = roomNme; // Используем имя пользователя как текст опции

      if (chckUserDrop == roomId) {
        userOption.selected = true;
      }
      return userOption;
    }

    // Обработчик события получения списка комнат с сервера
    socket.on("SetRooms", (rooms) => {
      const roomsDiv = document.getElementById("rooms");
      const chckUserDrop = userDropdown.value;

      roomsLet = rooms;

      roomsDiv.innerHTML = ""; // Очищаем содержимое контейнера комнат
      userDropdown.innerHTML = ""; // Очистите текущий список пользователей
      userDropdown.appendChild(createUserOption("all", "Всем", chckUserDrop)); // Добавьте опцию "Всем" в выпадающий список

      for (const roomId in rooms) {
        const room = rooms[roomId];

        // Заполнение списка пользователей
        const userOption = createUserOption(roomId, room, chckUserDrop);
        userDropdown.appendChild(userOption); // Добавьте опцию в выпадающий список

        // Создание элемента комнаты и добавление его в контейнер комнат
        const roomItem = createRoomItem(roomId, room);
        roomsDiv.appendChild(roomItem);
      }
    });

    // Обработчики событий для закрытия модального окна и переименования комнаты
    closeSpan.onclick = function () {
      renameModal.style.display = "none"; // Закрыть модальное окно при клике на (x)
    };

    window.onclick = function (event) {
      if (event.target == renameModal) {
        renameModal.style.display = "none"; // Закрыть модальное окно при клике вне его области
      }
    };

    modalRenameButton.addEventListener("click", renameRoom);
    function renameRoom() {
      const roomId = this.dataset.roomId; // Получение ID комнаты из атрибута data
      socket.emit("RenameRoom", roomId, newRoomName.value); // Отправка запроса на переименование комнаты
      renameModal.style.display = "none"; // Закрыть модальное окно
      socket.emit("GetRooms"); // Запрос обновленного списка комнат с сервера
    }

    //Обработка события кнопки создания страници видео для админа
    document
      .getElementById("videoPageButton")
      .addEventListener("click", function () {
        window.open("/conversation-room/:admin", "_blank");
      });

    //обработка события нажатия на конопку выхода из видео
    videoExitButton.addEventListener("click", function () {
      socket.emit("adminGotoRoom", "blanc");
    });
  </script>
</html>
